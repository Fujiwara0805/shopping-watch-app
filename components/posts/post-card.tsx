"use client";

import { useState, useCallback, useRef, useEffect, memo } from 'react';
import { motion } from 'framer-motion';
import { formatDistanceToNow, format } from 'date-fns'; // format„Çíimport„Å´ËøΩÂä†
import { ja } from 'date-fns/locale';
import { Heart, Share2, Clock, Link as LinkIcon, ExternalLink, Instagram, Copy, Laugh, Smile, Meh, Frown, Angry, MapPin, Eye, MessageCircle, ChevronDown, Tag, DollarSign, UserPlus, Info, ChevronLeft, ChevronRight, ShoppingCart, Utensils, Camera, GamepadIcon, Wrench, Layers, FileIcon, Calendar, Briefcase, ShoppingBag, Users, MessageSquareText, Trash2, Flag, AlertTriangle, Loader2, Star, Car, Home, Package, Megaphone, HandCoins } from 'lucide-react'; // Star, Car, Home, Package, Megaphone„Ç¢„Ç§„Ç≥„É≥„ÇíËøΩÂä†
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Card, CardContent, CardFooter, CardHeader } from '@/components/ui/card';
import { Carousel, CarouselContent, CarouselItem, CarouselNext, CarouselPrevious } from '@/components/ui/carousel';
import { cn } from '@/lib/utils';
import { PostWithAuthor, AuthorProfile } from '@/types/post';
import { supabase } from '@/lib/supabaseClient';
import { CustomModal } from '@/components/ui/custom-modal';
import { useToast } from '@/hooks/use-toast';
import React from 'react';
import { ExtendedPostWithAuthor } from '@/types/timeline';

const discountIcons = [
  { value: 0, Icon: Angry, label: "0%" },
  { value: 20, Icon: Frown, label: "20~40%" },
  { value: 40, Icon: Meh, label: "40~60%" },
  { value: 60, Icon: Smile, label: "60~80%" },
  { value: 80, Icon: Laugh, label: "80~100%" },
];

function formatRemainingTime(expiresAt: number): string {
  const now = Date.now();
  const remainingMillis = expiresAt - now;

  if (remainingMillis <= 0) return "Êé≤ËºâÁµÇ‰∫Ü";

  const hours = Math.floor(remainingMillis / (1000 * 60 * 60));
  const minutes = Math.floor((remainingMillis % (1000 * 60 * 60)) / (1000 * 60));
  
  if (hours > 0) {
    return `ÊÆã„ÇäÁ¥Ñ${hours}ÊôÇÈñì${minutes > 0 ? `${minutes}ÂàÜ` : ''}`;
  }
  return `ÊÆã„ÇäÁ¥Ñ${minutes}ÂàÜ`;
}

function formatDistance(distance?: number): string {
  if (!distance) return '';
  if (distance < 1000) {
    return `${Math.round(distance)}m`;
  }
  return `${(distance / 1000).toFixed(1)}km`;
}

function formatViewCount(count: number): string {
  if (count < 1000) {
    return count.toString();
  } else if (count < 10000) {
    return `${(count / 1000).toFixed(1)}k`;
  } else {
    return `${Math.floor(count / 1000)}k`;
  }
}

function formatCommentCount(count: number): string {
  if (count < 1000) {
    return count.toString();
  } else if (count < 10000) {
    return `${(count / 1000).toFixed(1)}k`;
  } else {
    return `${Math.floor(count / 1000)}k`;
  }
}

// üî• ÂØæË±°ËÄÖ„ÅÆ„É©„Éô„É´„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
function getTargetAudienceLabel(targetAudience?: string | null): string | null {
  if (!targetAudience) return null;
  
  const targetAudienceOptions = [
    { value: '„Åô„Åπ„Å¶„ÅÆ‰∫∫', label: '„Åô„Åπ„Å¶„ÅÆ‰∫∫' },
    { value: '10‰ª£', label: '10‰ª£' },
    { value: '20‰ª£', label: '20‰ª£' },
    { value: '30‰ª£', label: '30‰ª£' },
    { value: '40‰ª£', label: '40‰ª£' },
    { value: '50‰ª£', label: '50‰ª£' },
    { value: '60‰ª£‰ª•‰∏ä', label: '60‰ª£‰ª•‰∏ä' },
    { value: 'Â≠¶Áîü', label: 'Â≠¶Áîü' },
    { value: 'business_person', label: '„Éì„Ç∏„Éç„Çπ„Éû„É≥„ÉªOL' },
    { value: '‰∏ªÂ©¶„Éª‰∏ªÂ§´', label: '‰∏ªÂ©¶„Éª‰∏ªÂ§´' },
    { value: 'Â≠êËÇ≤„Å¶‰∏ñ‰ª£', label: 'Â≠êËÇ≤„Å¶‰∏ñ‰ª£' },
    { value: '‰∏Ä‰∫∫ÊöÆ„Çâ„Åó', label: '‰∏Ä‰∫∫ÊöÆ„Çâ„Åó' },
    { value: '„Éï„Ç°„Éü„É™„Éº', label: '„Éï„Ç°„Éü„É™„Éº' },
    { value: 'È´òÈΩ¢ËÄÖ', label: 'È´òÈΩ¢ËÄÖ' },
    { value: '„Éï„É™„Éº„É©„É≥„Çπ', label: '„Éï„É™„Éº„É©„É≥„Çπ' },
    { value: 'Ëµ∑Ê•≠ÂÆ∂„ÉªÁµåÂñ∂ËÄÖ', label: 'Ëµ∑Ê•≠ÂÆ∂„ÉªÁµåÂñ∂ËÄÖ' },
    { value: 'Ë¶≥ÂÖâÂÆ¢„ÉªÊóÖË°åËÄÖ', label: 'Ë¶≥ÂÖâÂÆ¢„ÉªÊóÖË°åËÄÖ' },
    { value: 'Âú∞Âüü‰ΩèÊ∞ë', label: 'Âú∞Âüü‰ΩèÊ∞ë' },
  ];
  
  const option = targetAudienceOptions.find(opt => opt.value === targetAudience);
  return option ? option.label : null;
}

interface PostCardProps {
  post: ExtendedPostWithAuthor;
  onLike?: (postId: string, isLiked: boolean) => Promise<void>;
  onView?: (postId: string) => Promise<void>;
  onComment?: (post: ExtendedPostWithAuthor) => void;
  onDelete?: (postId: string) => void;
  currentUserId?: string | null;
  showDistance?: boolean;
  isOwnPost?: boolean;
  onClick?: (postId: string) => void;
  disableClick?: boolean;
  enableComments?: boolean;
}

// ÊúÄÈÅ©Âåñ„Åï„Çå„ÅüÁîªÂÉè„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const OptimizedImage = memo(({ 
  src, 
  alt, 
  className, 
  onLoad,
  onError 
}: { 
  src: string; 
  alt: string; 
  className?: string;
  onLoad?: () => void;
  onError?: () => void;
}) => {
  const [isLoaded, setIsLoaded] = useState(false);
  const [hasError, setHasError] = useState(false);
  const [isInView, setIsInView] = useState(false);
  const imgRef = useRef<HTMLImageElement>(null);
  const [loadStarted, setLoadStarted] = useState(false);

  useEffect(() => {
    const img = imgRef.current;
    if (!img) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !loadStarted) {
            setIsInView(true);
            setLoadStarted(true);
            observer.unobserve(img);
          }
        });
      },
      {
        rootMargin: '50px',
        threshold: 0.1
      }
    );

    observer.observe(img);
    return () => observer.unobserve(img);
  }, [loadStarted]);

  useEffect(() => {
    if (isInView && !isLoaded && !hasError) {
      const img = new Image();
      img.onload = () => {
        setIsLoaded(true);
        onLoad?.();
      };
      img.onerror = () => {
        setHasError(true);
        onError?.();
      };
      img.src = src;
    }
  }, [isInView, src, isLoaded, hasError, onLoad, onError]);

  return (
    <div ref={imgRef} className={cn("relative overflow-hidden", className)}>
      {!isLoaded && !hasError && (
        <div className="absolute inset-0 bg-gradient-to-br from-gray-200 to-gray-300 animate-pulse flex items-center justify-center">
          <div className="w-8 h-8 bg-gray-400 rounded animate-pulse" />
        </div>
      )}
      
      {hasError && (
        <div className="absolute inset-0 bg-gray-200 flex items-center justify-center">
          <div className="text-gray-500 text-sm text-center">
            <div className="w-8 h-8 bg-gray-400 rounded mx-auto mb-2" />
            ÁîªÂÉè„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì
          </div>
        </div>
      )}
      
      {isLoaded && !hasError && (
        <motion.img
          src={src}
          alt={alt}
          className="w-full h-full object-cover"
          initial={{ opacity: 0, scale: 1.1 }}
          animate={{ opacity: 1, scale: 1 }}
          transition={{ duration: 0.3 }}
          loading="lazy"
        />
      )}
    </div>
  );
});

OptimizedImage.displayName = 'OptimizedImage';

const DiscountBadge = memo(({ discountRate }: { discountRate: number | null | undefined }) => {
  if (discountRate == null) return null;

  const selectedOption = discountIcons.find(option => option.value === discountRate);
  const displayIcon = selectedOption ? selectedOption.Icon : Angry;

  return (
    <motion.div
      initial={{ scale: 0.8, opacity: 0 }}
      animate={{ scale: 1, opacity: 1 }}
      transition={{ delay: 0.2, duration: 0.3 }}
    >
      <Badge className="bg-primary text-primary-foreground font-bold text-xl px-2 py-1 shadow-sm flex items-center">
        {React.createElement(displayIcon, { className: "h-6 w-6" })}
      </Badge>
    </motion.div>
  );
});

DiscountBadge.displayName = 'DiscountBadge';

// Êñ∞Ë¶èËøΩÂä†ÔºöRatingDisplay„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà (post-card.tsxÂÜÖ„Åß‰ΩøÁî®„Åô„Çã„Åü„ÇÅ‰øÆÊ≠£)
const RatingDisplay = memo(({ rating }: { rating: number | null | undefined }) => {
  if (rating == null) return null;

  const fullStars = Math.floor(rating);
  const hasHalfStar = rating - fullStars >= 0.5;

  return (
    <div className="flex items-center space-x-0.5">
      {[...Array(5)].map((_, i) => {
        const isFull = i < fullStars;
        const isHalf = i === fullStars && hasHalfStar;

        return (
          <div key={i} className="relative">
            <Star
              className={cn(
                "h-4 w-4 text-gray-300",
                { "fill-yellow-400": isFull || isHalf }
              )}
            />
            {isHalf && (
              <div
                className="absolute inset-0 overflow-hidden"
                style={{ width: '50%' }}
              >
                <Star className="h-4 w-4 text-yellow-400 fill-yellow-400" />
              </div>
            )}
          </div>
        );
      })}
      <span className="text-sm font-medium ml-1" style={{ color: '#73370c' }}>({rating.toFixed(1)})</span>
    </div>
  );
});

RatingDisplay.displayName = 'RatingDisplay';

const UserAvatar = memo(({ author }: { author: AuthorProfile | null }) => {
  const authorAvatarUrl = author?.avatar_url
    ? supabase.storage.from('avatars').getPublicUrl(author.avatar_url).data.publicUrl
    : null;

  return (
    <Avatar className="h-7 w-7">
      <AvatarImage src={authorAvatarUrl || undefined} alt={author?.display_name || 'ÊäïÁ®øËÄÖ'} />
      <AvatarFallback className="text-xs">{author?.display_name?.charAt(0) || '?'}</AvatarFallback>
    </Avatar>
  );
});

UserAvatar.displayName = 'UserAvatar';

export const PostCard = memo(({ 
  post, 
  onLike, 
  onView,
  onComment,
  onDelete,
  currentUserId, 
  showDistance = false, 
  isOwnPost, 
  onClick,
  disableClick = false,
  enableComments = false
}: PostCardProps) => {
  const [showShareDialog, setShowShareDialog] = useState(false);
  const [showBasicInfo, setShowBasicInfo] = useState(false);
  const [imageLoaded, setImageLoaded] = useState(false);
  const [isLiking, setIsLiking] = useState(false);
  const [hasBeenViewed, setHasBeenViewed] = useState(false);
  
  // üî• ËøΩÂä†ÔºöÂâäÈô§„ÉªÈÄöÂ†±„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [showReportModal, setShowReportModal] = useState(false);
  const [isDeleting, setIsDeleting] = useState(false);
  const [reportReason, setReportReason] = useState('');
  const [reportDetails, setReportDetails] = useState('');
  const [isReporting, setIsReporting] = useState(false);
  
  // üî• ËøΩÂä†ÔºöÂøúÊè¥Ë≥ºÂÖ•„ÅÆ„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãÁÆ°ÁêÜ
  const [supportPurchaseLoading, setSupportPurchaseLoading] = useState<{ [key: string]: boolean }>({});
  
  const { toast } = useToast();
  const cardRef = useRef<HTMLDivElement>(null);

  const isMyPost = isOwnPost || (post.author_user_id === currentUserId);

  const [anonymousLikedPosts, setAnonymousLikedPosts] = useState<string[]>([]);
  
  useEffect(() => {
    if (!currentUserId) {
      const anonymousLikes = JSON.parse(localStorage.getItem('anonymousLikes') || '[]');
      setAnonymousLikedPosts(anonymousLikes);
    }
  }, [currentUserId]);

  // „Éì„É•„ÉºÊï∞„Ç´„Ç¶„É≥„ÉàÔºàIntersection Observer‰ΩøÁî®Ôºâ
  useEffect(() => {
    if (!onView || hasBeenViewed) return;

    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
            setHasBeenViewed(true);
            onView(post.id);
            observer.unobserve(entry.target);
          }
        });
      },
      {
        threshold: 0.5,
        rootMargin: '0px'
      }
    );

    if (cardRef.current) {
      observer.observe(cardRef.current);
    }

    return () => observer.disconnect();
  }, [onView, post.id, hasBeenViewed]);

  const isLiked = currentUserId 
    ? post.isLikedByCurrentUser 
    : anonymousLikedPosts.includes(post.id);

  const handleLikeClick = useCallback(async (e: React.MouseEvent) => {
    e.stopPropagation();
    
    if (isLiking) return;
    
    if (isMyPost && currentUserId) {
      toast({
        title: "Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Å´„ÅØ„ÅÑ„ÅÑ„Å≠„Åß„Åç„Åæ„Åõ„Çì",
        duration: 1000,
      });
      return;
    }

    if (!currentUserId) {
      const anonymousLikes = JSON.parse(localStorage.getItem('anonymousLikes') || '[]');
      const alreadyLiked = anonymousLikes.includes(post.id);
      
      if (alreadyLiked && !isLiked) {
        setAnonymousLikedPosts(prev => prev.filter(id => id !== post.id));
        return;
      } else if (!alreadyLiked && isLiked) {
        setAnonymousLikedPosts(prev => [...prev, post.id]);
        return;
      }
    }
    
    if (onLike) {
      setIsLiking(true);
      try {
        await onLike(post.id, !isLiked);
        
        if (!currentUserId) {
          if (!isLiked) {
            setAnonymousLikedPosts(prev => [...prev, post.id]);
          } else {
            setAnonymousLikedPosts(prev => prev.filter(id => id !== post.id));
          }
        }
      } catch (error) {
        console.error('„ÅÑ„ÅÑ„Å≠Âá¶ÁêÜ„Ç®„É©„Éº:', error);
        toast({
          title: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
          description: "„ÅÑ„ÅÑ„Å≠Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ",
          duration: 1000,
        });
      } finally {
        setIsLiking(false);
      }
    }
  }, [onLike, post.id, isLiked, isLiking, toast, isMyPost, currentUserId]);

  const handleShareClick = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    setShowShareDialog(true);
  }, []);

  const handleCommentClick = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    if (onComment) {
      onComment(post);
    }
  }, [onComment, post]);

  const handleCardClick = useCallback(() => {
    if (!disableClick && onClick) {
      onClick(post.id);
    }
  }, [disableClick, onClick, post.id]);
  
  // „Ç∏„É£„É≥„É´„ÅÆ„Ç¢„Ç§„Ç≥„É≥„Å®„Ç´„É©„Éº„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
  const getGenreIconAndColor = useCallback((genre: string) => {
    switch(genre) {
      case '„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞':
        return {
          icon: ShoppingCart,
          bgColor: 'bg-purple-100',
          textColor: 'text-purple-800',
          borderColor: 'border-purple-200'
        };
      case 'È£≤È£üÂ∫ó':
        return {
          icon: Utensils,
          bgColor: 'bg-orange-100',
          textColor: 'text-orange-800',
          borderColor: 'border-orange-200'
        };
      case 'Ë¶≥ÂÖâ':
        return {
          icon: Camera,
          bgColor: 'bg-teal-100',
          textColor: 'text-teal-800',
          borderColor: 'border-teal-200'
        };
      case '„Ç®„É≥„Çø„É°': // „É¨„Ç∏„É£„Éº„Åã„ÇâÂ§âÊõ¥
        return {
          icon: GamepadIcon,
          bgColor: 'bg-pink-100',
          textColor: 'text-pink-800',
          borderColor: 'border-pink-200'
        };
      case '„Çµ„Éº„Éì„Çπ':
        return {
          icon: Wrench,
          bgColor: 'bg-indigo-100',
          textColor: 'text-indigo-800',
          borderColor: 'border-indigo-200'
        };
      case '„Ç§„Éô„É≥„Éà':
        return {
          icon: Calendar,
          bgColor: 'bg-yellow-100',
          textColor: 'text-yellow-800',
          borderColor: 'border-yellow-200'
        };
      case 'Ê±Ç‰∫∫':
        return {
          icon: Briefcase,
          bgColor: 'bg-blue-100',
          textColor: 'text-blue-800',
          borderColor: 'border-blue-200'
        };
      case 'Ë≤©Â£≤':
        return {
          icon: ShoppingBag,
          bgColor: 'bg-green-100',
          textColor: 'text-green-800',
          borderColor: 'border-green-200'
        };
      case '„Éú„É©„É≥„ÉÜ„Ç£„Ç¢':
        return {
          icon: Users,
          bgColor: 'bg-emerald-100',
          textColor: 'text-emerald-800',
          borderColor: 'border-emerald-200'
        };
      case 'Áõ∏Ë´á':
        return {
          icon: MessageSquareText,
          bgColor: 'bg-rose-100',
          textColor: 'text-rose-800',
          borderColor: 'border-rose-200'
        };
      case '„Ç∑„Çß„Ç¢': // Êñ∞Ë¶èËøΩÂä†
        return {
          icon: Users, // ÈÅ©Âàá„Å™„Ç¢„Ç§„Ç≥„É≥„ÇíÈÅ∏Êäû
          bgColor: 'bg-orange-100',
          textColor: 'text-orange-800',
          borderColor: 'border-orange-200'
        };
      case '„Ç≥„Éü„É•„Éã„ÉÜ„Ç£': // Êñ∞Ë¶èËøΩÂä†
        return {
          icon: MessageCircle, // ÈÅ©Âàá„Å™„Ç¢„Ç§„Ç≥„É≥„ÇíÈÅ∏Êäû
          bgColor: 'bg-purple-100',
          textColor: 'text-purple-800',
          borderColor: 'border-purple-200'
        };
      case 'ÂãüÈõÜ': // Êñ∞Ë¶èËøΩÂä†
        return {
          icon: UserPlus, // ÈÅ©Âàá„Å™„Ç¢„Ç§„Ç≥„É≥„ÇíÈÅ∏Êäû
          bgColor: 'bg-cyan-100',
          textColor: 'text-cyan-800',
          borderColor: 'border-cyan-200'
        };
      case '„Éá„É™„Éê„É™„Éº':
        return {
          icon: Package,
          bgColor: 'bg-green-100',
          textColor: 'text-green-800',
          borderColor: 'border-green-200'
        };
      default:
        return {
          icon: Layers,
          bgColor: 'bg-slate-100',
          textColor: 'text-slate-800',
          borderColor: 'border-slate-200'
        };
    }
  }, []);

  // „Ç´„ÉÜ„Ç¥„É™„Ç´„É©„Éº„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞ (‰∏çÊòé„ÅÆÂÆöÁæ©„ÇíÂâäÈô§)
  const getCategoryColor = useCallback((category: string) => {
    switch(category) {
      // „Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞Á≥ª
      case 'ÊÉ£Ëèú':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'ÂºÅÂΩì':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'ËÇâ':
        return 'bg-red-100 text-red-800 border-red-200';
      case 'È≠ö':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'ÈáéËèú':
        return 'bg-emerald-100 text-emerald-800 border-emerald-200';
      case 'ÊûúÁâ©':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'Á±≥„Éª„Éë„É≥È°û':
        return 'bg-amber-100 text-amber-800 border-amber-200';
      case '„Éá„Ç∂„Éº„ÉàÈ°û':
        return 'bg-pink-100 text-pink-800 border-pink-200';
      case 'Êó•Áî®ÂìÅ':
        return 'bg-cyan-100 text-cyan-800 border-cyan-200';
      case 'Ë°£ÊñôÂìÅ':
        return 'bg-violet-100 text-violet-800 border-violet-200';
      
      // È£≤È£üÂ∫óÁ≥ª
      case 'ÂíåÈ£ü':
        return 'bg-red-100 text-red-800 border-red-200';
      case 'Ê¥ãÈ£ü':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '‰∏≠ËèØ':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case '„Ç§„Çø„É™„Ç¢„É≥':
        return 'bg-green-100 text-green-800 border-green-200';
      case '„Éï„É¨„É≥„ÉÅ':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case '„Ç´„Éï„Çß':
        return 'bg-amber-100 text-amber-800 border-amber-200';
      case '„Éï„Ç°„Çπ„Éà„Éï„Éº„Éâ':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      
      // Ë¶≥ÂÖâÁ≥ª
      case 'Ë¶≥ÂÖâ„Çπ„Éù„ÉÉ„Éà':
        return 'bg-teal-100 text-teal-800 border-teal-200';
      case 'ÂÆøÊ≥äÊñΩË®≠':
        return 'bg-indigo-100 text-indigo-800 border-indigo-200';
      case 'Ê∏©Ê≥â':
        return 'bg-rose-100 text-rose-800 border-rose-200';
      case 'ÂçöÁâ©È§®„ÉªÁæéË°ìÈ§®':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case 'ÂÖ¨Âúí':
        return 'bg-green-100 text-green-800 border-green-200';
      
      // „Ç®„É≥„Çø„É°Á≥ª (Êóß„É¨„Ç∏„É£„Éº)
      case '„Ç¢„Éü„É•„Éº„Ç∫„É°„É≥„Éà':
        return 'bg-pink-100 text-pink-800 border-pink-200';
      case '„Çπ„Éù„Éº„ÉÑ':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'Êò†Áîª„Éª„Ç®„É≥„Çø„É°':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case '„Ç¢„Ç¶„Éà„Éâ„Ç¢':
        return 'bg-green-100 text-green-800 border-green-200';
      
      // „Çµ„Éº„Éì„ÇπÁ≥ª
      case 'ÁæéÂÆπ„ÉªÂÅ•Â∫∑':
        return 'bg-pink-100 text-pink-800 border-pink-200';
      case 'ÊïôËÇ≤':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'ÂåªÁôÇ':
        return 'bg-red-100 text-red-800 border-red-200';
      case '‰øÆÁêÜ„Éª„É°„É≥„ÉÜ„Éä„É≥„Çπ':
        return 'bg-gray-100 text-gray-800 border-gray-200';
      
      // „Ç§„Éô„É≥„ÉàÁ≥ª
      case '„Ç≥„É≥„Çµ„Éº„Éà„Éª„É©„Ç§„Éñ':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case '„Éï„Çß„Çπ„ÉÜ„Ç£„Éê„É´':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'Â±ïÁ§∫‰ºö':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '„Çª„Éü„Éä„Éº„ÉªË¨õÂ∫ß':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'sports„Ç§„Éô„É≥„Éà':
        return 'bg-red-100 text-red-800 border-red-200';
      
      // Ê±Ç‰∫∫Á≥ª
      case 'Ê≠£Á§æÂì°':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '„Ç¢„É´„Éê„Ç§„Éà„Éª„Éë„Éº„Éà':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'Ê¥æÈÅ£„ÉªÂ•ëÁ¥Ñ':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case '„Ç§„É≥„Çø„Éº„É≥':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case '„Éï„É™„Éº„É©„É≥„Çπ':
        return 'bg-teal-100 text-teal-800 border-teal-200';
      
      // Ë≤©Â£≤Á≥ª
      case 'Êñ∞ÂìÅ':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '‰∏≠Âè§ÂìÅ':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case '„Éè„É≥„Éâ„É°„Ç§„Éâ':
        return 'bg-pink-100 text-pink-800 border-pink-200';
      case '„Éá„Ç∏„Çø„É´ÂïÜÂìÅ':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case '„ÉÅ„Ç±„ÉÉ„Éà':
        return 'bg-red-100 text-red-800 border-red-200';
      case 'ÁßªÂãïË≤©Â£≤':
        return 'bg-green-100 text-green-800 border-green-200';
      
      // „Éú„É©„É≥„ÉÜ„Ç£„Ç¢Á≥ª
      case 'Áí∞Â¢É„ÉªËá™ÁÑ∂':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'Á¶èÁ•â„Éª‰ªãË≠∑':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'ÊïôËÇ≤„ÉªÂ≠êËÇ≤„Å¶':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'Âú∞ÂüüÊ¥ªÂãï':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case 'ÁÅΩÂÆ≥ÊîØÊè¥':
        return 'bg-red-100 text-red-800 border-red-200';
      
      // Áõ∏Ë´áÁ≥ª
      case 'ÁîüÊ¥ªÁõ∏Ë´á':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '‰ªï‰∫ã„Éª„Ç≠„É£„É™„Ç¢':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'ÊÅãÊÑõ„Éª‰∫∫ÈñìÈñ¢‰øÇ':
        return 'bg-pink-100 text-pink-800 border-pink-200';
      case 'Ê≥ïÂæã„Éª„ÅäÈáë':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'ÂÅ•Â∫∑„ÉªÂåªÁôÇ':
        return 'bg-red-100 text-red-800 border-red-200';

      // „Ç∑„Çß„Ç¢Á≥ª (Êñ∞Ë¶èËøΩÂä†)
      case '„Çø„ÇØ„Ç∑„Éº':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case '„É©„Ç§„Éâ„Ç∑„Çß„Ç¢':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case '„Ç´„Éº„Ç∑„Çß„Ç¢':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '„Éõ„ÉÜ„É´':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case 'Ê∞ëÊ≥ä':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'ÊóÖÈ§®':
        return 'bg-red-100 text-red-800 border-red-200';
      case '„Ç≥„É≥„Éâ„Éü„Éã„Ç¢„É†':
        return 'bg-purple-100 text-purple-800 border-purple-200';

      // „Ç≥„Éü„É•„Éã„ÉÜ„Ç£Á≥ª (Êñ∞Ë¶èËøΩÂä†)
      case '‰∫§ÊµÅ':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '„Ç§„Éô„É≥„Éà':
        return 'bg-yellow-100 text-yellow-800 border-yellow-200';
      case 'Ë∂£Âë≥':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'Â≠¶Áøí':
        return 'bg-purple-100 text-purple-800 border-purple-200';
      case 'Âú∞Âüü':
        return 'bg-teal-100 text-teal-800 border-teal-200';

      // ÂãüÈõÜÁ≥ª (Êñ∞Ë¶èËøΩÂä†)
      case '„É°„É≥„Éê„ÉºÂãüÈõÜ':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'Âä©„ÅëÂêà„ÅÑ':
        return 'bg-blue-100 text-blue-800 border-blue-200';
      case '„Éú„É©„É≥„ÉÜ„Ç£„Ç¢':
        return 'bg-green-100 text-green-800 border-green-200';
      case 'ÂèÇÂä†ËÄÖÂãüÈõÜ':
        return 'bg-red-100 text-red-800 border-red-200';
      
      // „Éá„É™„Éê„É™„ÉºÁ≥ª
      case '„Éï„Éº„Éâ„Éá„É™„Éê„É™„Éº':
        return 'bg-orange-100 text-orange-800 border-orange-200';
      case 'Êó•Áî®ÂìÅ„Éá„É™„Éê„É™„Éº':
        return 'bg-teal-100 text-teal-800 border-teal-200';
      case 'Ëñ¨Â±Ä„Éá„É™„Éê„É™„Éº':
        return 'bg-red-100 text-red-800 border-red-200';

      default: // Êú™ÂÆöÁæ©„ÅÆ„Ç´„ÉÜ„Ç¥„É™„Å´ÂØæ„Åô„Çã„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        return 'bg-gray-100 text-gray-800 border-gray-200';
    }
  }, []);
  
  const formattedDate = post.created_at ? formatDistanceToNow(new Date(post.created_at), { 
    addSuffix: true,
    locale: ja
  }) : 'Êó•‰ªò‰∏çÊòé';

  // Êñ∞Ë¶èËøΩÂä†: Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„Éà
  const formattedStartDate = post.start_date ? format(new Date(post.start_date), "yyyyÂπ¥MMÊúàddÊó• HH:mm", { locale: ja }) : null;
  const formattedEndDate = post.end_date ? format(new Date(post.end_date), "yyyyÂπ¥MMÊúàddÊó• HH:mm", { locale: ja }) : null;

  const copyToClipboard = useCallback((text: string, message: string) => {
    navigator.clipboard.writeText(text).then(() => {
      toast({
        title: `‚úÖ ${message}`,
        duration: 1000,
      });
      setShowShareDialog(false);
    }).catch(err => console.error("„Ç≥„Éî„ÉºÂ§±Êïó:", err));
  }, [toast]);

  const handleCopyStoreName = useCallback((e: React.MouseEvent) => {
    e.stopPropagation();
    if (post.store_name) {
      copyToClipboard(post.store_name, `„Äå${post.store_name}„Äç„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ`);
    }
  }, [post.store_name, copyToClipboard]);

  const handleInstagramShare = useCallback(() => {
    const postUrl = `${window.location.origin}/post/${post.id}`;
    copyToClipboard(postUrl, "ÊäïÁ®ø„ÅÆ„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü„ÄÇInstagram„Ç¢„Éó„É™„ÇíÈñã„ÅÑ„Å¶ÂÖ±Êúâ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
    setShowShareDialog(false);
  }, [post.id, copyToClipboard]);

  const handleNativeShare = useCallback(async () => {
    const shareData = {
      title: `${post.store_name}„ÅÆ${post.category}„Åå„ÅäÂæóÔºÅ`,
      text: post.content,
      url: `${window.location.origin}/post/${post.id}`,
    };
    if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
      try {
        await navigator.share(shareData);
        setShowShareDialog(false);
      } catch (error) {
        console.error('„Éç„Ç§„ÉÜ„Ç£„ÉñÂÖ±ÊúâÂ§±Êïó:', error);
      }
    } else {
      copyToClipboard(shareData.url, "„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
    }
  }, [post.store_name, post.category, post.content, post.id, copyToClipboard]);

  // Ë§áÊï∞ÁîªÂÉè„ÅÆÂá¶ÁêÜ
  const getImageUrls = useCallback(() => {
    if (post.image_urls) {
      try {
        const urls = JSON.parse(post.image_urls);
        return Array.isArray(urls) ? urls : [];
      } catch (error) {
        console.error('ÁîªÂÉèURLs„ÅÆËß£Êûê„Ç®„É©„Éº:', error);
        return [];
      }
    }
    return [];
  }, [post.image_urls]);

  // „Éï„Ç°„Ç§„É´URL„ÅÆÂá¶ÁêÜ
  const getFileUrls = useCallback(() => {
    if (post.file_urls) {
      try {
        const urls = JSON.parse(post.file_urls);
        return Array.isArray(urls) ? urls : [];
      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´URLs„ÅÆËß£Êûê„Ç®„É©„Éº:', error);
        return [];
      }
    }
    return [];
  }, [post.file_urls]);

  // „Éï„Ç°„Ç§„É´„Ç¢„Ç§„Ç≥„É≥„ÅÆÂèñÂæó
  const getFileIcon = useCallback((fileName: string) => {
    const extension = fileName.split('.').pop()?.toLowerCase();
    switch (extension) {
      case 'pdf':
        return 'üìÑ';
      case 'doc':
      case 'docx':
        return 'üìù';
      case 'xls':
      case 'xlsx':
        return 'üìä';
      default:
        return 'üìé';
    }
  }, []);

  const imageUrls = getImageUrls();
  const fileUrls = getFileUrls();

  const genreIconAndColor = getGenreIconAndColor(post.genre || '');
  const GenreIcon = genreIconAndColor.icon;

  // üî• ËøΩÂä†ÔºöÊäïÁ®øÂâäÈô§Âá¶ÁêÜ
  const handleDeletePost = async () => {
    if (!currentUserId || !isMyPost) return;

    setIsDeleting(true);
    try {
      // Ë´ñÁêÜÂâäÈô§„Å´Â§âÊõ¥
      const { error } = await supabase
        .from('posts')
        .update({ is_deleted: true })
        .eq('id', post.id);

      if (error) {
        console.error('ÊäïÁ®øÂâäÈô§„Ç®„É©„Éº:', error);
        throw error;
      }

      toast({
        title: "ÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü",
        duration: 1000,
      });

      setShowDeleteModal(false);
      
      // Ë¶™„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å´ÂâäÈô§„ÇíÈÄöÁü•
      if (onDelete) {
        onDelete(post.id);
      }
    } catch (error) {
      console.error('ÊäïÁ®ø„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
      toast({
        title: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
        description: "ÊäïÁ®ø„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
        duration: 3000,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  // üî• ËøΩÂä†ÔºöÈÄöÂ†±Âá¶ÁêÜ
  const handleReportPost = async () => {
    if (!reportReason.trim()) {
      toast({
        title: "ÈÄöÂ†±ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ",
        duration: 2000,
      });
      return;
    }

    setIsReporting(true);
    try {
      // „ÅäÂïè„ÅÑÂêà„Çè„Åõ„Éï„Ç©„Éº„É†„Å´ÈÄÅ‰ø°
      const response = await fetch('/api/contact', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name: 'ÈÄöÂ†±„Ç∑„Çπ„ÉÜ„É†',
          email: 'report@tokudoku.com',
          subject: `ÊäïÁ®øÈÄöÂ†± - ${post.id}`,
          message: `
„ÄêÊäïÁ®øÈÄöÂ†±„Äë
ÊäïÁ®øID: ${post.id}
ÊäïÁ®øËÄÖ: ${post.author?.display_name || '‰∏çÊòé'}
Â∫óËàóÂêç: ${post.store_name}
ÊäïÁ®øÂÜÖÂÆπ: ${post.content}

ÈÄöÂ†±ÁêÜÁî±: ${reportReason}
Ë©≥Á¥∞: ${reportDetails || '„Å™„Åó'}

ÈÄöÂ†±ËÄÖ: ${currentUserId ? '„É≠„Ç∞„Ç§„É≥„É¶„Éº„Ç∂„Éº' : 'ÂåøÂêç„É¶„Éº„Ç∂„Éº'}
ÈÄöÂ†±Êó•ÊôÇ: ${new Date().toLocaleString('ja-JP')}
          `,
        }),
      });

      if (!response.ok) {
        throw new Error('ÈÄöÂ†±„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }

      toast({
        title: "ÈÄöÂ†±„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü",
        description: "ÊãÖÂΩìËÄÖ„ÅåÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„ÅÑ„Åü„Åó„Åæ„Åô",
        duration: 2000,
      });

      setShowReportModal(false);
      setReportReason('');
      setReportDetails('');
    } catch (error) {
      console.error('ÈÄöÂ†±„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü:', error);
      toast({
        title: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
        description: "ÈÄöÂ†±„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü",
        duration: 3000,
      });
    } finally {
      setIsReporting(false);
    }
  };

  // üî• ÂøúÊè¥Ë≥ºÂÖ•„Éè„É≥„Éâ„É©„Éº„Çí‰øÆÊ≠£Ôºà„É≠„Éº„Éá„Ç£„É≥„Ç∞Áä∂ÊÖãËøΩÂä†Ôºâ
  const handleSupportPurchase = useCallback(async (postId: string, amount: number) => {
    const loadingKey = `${postId}-${amount}`;
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÈñãÂßã
    setSupportPurchaseLoading(prev => ({ ...prev, [loadingKey]: true }));

    try {
      const response = await fetch('/api/support-purchase/create-checkout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          postId,
          amount,
        }),
      });

      const data = await response.json();
      
      if (data.checkoutUrl) {
        window.location.href = data.checkoutUrl;
      } else {
        // „Çà„ÇäÂÖ∑‰ΩìÁöÑ„Å™„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        let errorTitle = "ÂøúÊè¥Ë≥ºÂÖ•„Åß„Åç„Åæ„Åõ„Çì";
        let errorDescription = data.error || 'Ê±∫Ê∏àURL„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
        
        // üî• ‰øÆÊ≠£Ôºö„Ç®„É©„Éº„Ç≥„Éº„Éâ„Å´Âøú„Åò„ÅüË©≥Á¥∞„É°„ÉÉ„Çª„Éº„Ç∏
        if (data.errorCode === 'SELLER_STRIPE_ACCOUNT_NOT_FOUND') {
          errorTitle = "ÂøúÊè¥Ë≥ºÂÖ•Ë®≠ÂÆöÊú™ÂÆå‰∫Ü";
          errorDescription = data.error;
        } else if (data.errorCode === 'SELLER_STRIPE_SETUP_INCOMPLETE') {
          errorTitle = "ÂøúÊè¥Ë≥ºÂÖ•Ë®≠ÂÆöÊú™ÂÆå‰∫Ü";
          errorDescription = data.error;
        } else if (data.errorCode === 'SELLER_PAYOUT_NOT_ENABLED') {
          errorTitle = "ÊîØÊâï„ÅÑÂèóÂèñË®≠ÂÆöÊú™ÂÆå‰∫Ü";
          errorDescription = data.error;
        }
        
        toast({
          title: errorTitle,
          description: errorDescription,
          duration: 5000, // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÈï∑„ÇÅ„Å´Ë°®Á§∫
        });
      }
    } catch (error) {
      console.error('Support purchase error:', error);
      toast({
        title: "„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü",
        description: "Ê±∫Ê∏àÂá¶ÁêÜ„ÅÆÈñãÂßã„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
        duration: 3000,
      });
    } finally {
      // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁµÇ‰∫Ü
      setSupportPurchaseLoading(prev => ({ ...prev, [loadingKey]: false }));
    }
  }, [toast]);

  return (
    <>
      <Card 
        ref={cardRef}
        className={cn(
          "overflow-hidden transition-all duration-200",
          !disableClick && "hover:shadow-lg cursor-pointer",
          isMyPost && "ring-2 ring-blue-200 bg-blue-50/30"
        )}
        onClick={handleCardClick}
      >
        <CardHeader className="p-3 pb-1 space-y-0">
          {/* ÊäïÁ®øËÄÖÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ÔºàÁã¨Á´ãÔºâ */}
          <div className="flex justify-between items-start mb-3">
            <div className="flex items-center space-x-2">
              <UserAvatar author={post.author} />
              <div className="flex flex-col">
                <div className="flex items-center space-x-2">
                  <p className="font-semibold text-base" style={{ color: '#73370c' }}>
                    {post.author?.display_name || '‰∏çÊòé„Å™ÊäïÁ®øËÄÖ'}
                  </p>
                  {isMyPost && <Badge variant="secondary" className="text-xs">Ëá™ÂàÜ„ÅÆÊäïÁ®ø</Badge>}
                  {/* Ë©ï‰æ°Ë°®Á§∫„ÅØË©≥Á¥∞ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥„Å∏ÁßªÂãï */}
                </div>
                <div className="flex items-center space-x-2">
                  {post.author_posts_count && post.author_posts_count > 0 && (
                    <>
                      <p className="text-xs" style={{ color: '#73370c' }}>
                        ÊäïÁ®øÊï∞: {post.author_posts_count}
                      </p>
                      <span className="text-xs" style={{ color: '#73370c' }}>‚Ä¢</span>
                    </>
                  )}
                  <p className="text-xs" style={{ color: '#73370c' }}>
                    {formattedDate}
                  </p>
                </div>
              </div>
            </div>
            
            {/* üî• ËøΩÂä†ÔºöËá™ÂàÜ„ÅÆÊäïÁ®ø„ÅÆÂ†¥Âêà„ÅØÂâäÈô§„Éú„Çø„É≥ */}
            {isMyPost && currentUserId && (
              <Button
                variant="ghost"
                size="sm"
                onClick={(e) => {
                  e.stopPropagation();
                  setShowDeleteModal(true);
                }}
                className="text-red-500 hover:text-red-700 hover:bg-red-50"
                title="ÊäïÁ®ø„ÇíÂâäÈô§"
              >
                <Trash2 className="h-4 w-4" />
              </Button>
            )}
          </div>
          
          {/* Ë©≥Á¥∞ÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥Ôºà„Éà„Ç∞„É´ÂΩ¢Âºè„Éª6Ë°å2ÂàóË°®ÂΩ¢ÂºèÔºâ */}
          <div className="mt-1">
            <div className="border border-gray-200 rounded-md overflow-hidden">
              {/* „Éà„Ç∞„É´„Éò„ÉÉ„ÉÄ„Éº */}
              <button
                onClick={() => setShowBasicInfo(!showBasicInfo)}
                className="w-full bg-gray-50 border-b border-gray-200 p-3 flex items-center justify-between hover:bg-gray-100 transition-colors"
              >
                <div className="flex items-center space-x-2">
                  <Info className="h-4 w-4 text-gray-500" />
                  <span className="text-base font-medium" style={{ color: '#73370c' }}>Ë©≥Á¥∞ÊÉÖÂ†±</span>
                </div>
                <motion.div
                  animate={{ rotate: showBasicInfo ? 180 : 0 }}
                  transition={{ duration: 0.2 }}
                >
                  <ChevronDown className="h-4 w-4 text-gray-500" />
                </motion.div>
              </button>
              
              {/* „Éà„Ç∞„É´„Ç≥„É≥„ÉÜ„É≥„ÉÑ */}
              <motion.div
                initial={false}
                animate={{ height: showBasicInfo ? 'auto' : 0 }}
                transition={{ duration: 0.2 }}
                className="overflow-hidden"
              >
                <div className="bg-white">
                  <table className="w-full">
                    <tbody>
                      {/* Ë©ï‰æ°Ë°®Á§∫ (Êñ∞„Åó„ÅÑË°å„Å®„Åó„Å¶ËøΩÂä†) */}
                      {post.rating != null && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <Star className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>Ë©ï‰æ°</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <RatingDisplay rating={post.rating} />
                          </td>
                        </tr>
                      )}

                      {/* ÊúüÈñìË°®Á§∫ (ÈñãÂßãÊó•„ÉªÁµÇ‰∫ÜÊó•) */}
                      {(post.start_date || post.end_date) && ( // „Å©„Å°„Çâ„Åã‰∏ÄÊñπ„Åß„ÇÇ„ÅÇ„Çå„Å∞Ë°®Á§∫
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <Calendar className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>ÊúüÈñì</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <span className="text-base font-medium" style={{ color: '#73370c' }}>
                              {post.start_date && format(new Date(post.start_date), "yyyyÂπ¥MMÊúàddÊó• HH:mm", { locale: ja })}
                              {post.start_date && post.end_date && " ~ "}
                              {post.end_date && format(new Date(post.end_date), "yyyyÂπ¥MMÊúàddÊó• HH:mm", { locale: ja })}
                            </span>
                          </td>
                        </tr>
                      )}
                      
                      {/* 1Ë°åÁõÆ: Â†¥ÊâÄ - Â∫óËàóID„Åå„ÅÇ„Çä„ÄÅÂ∫óËàóÂêç„Åå„ÄåÂ∫óËàó‰∏çÊòé„Äç‰ª•Â§ñ„ÅÆÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ */}
                      {post.store_id && post.store_name && post.store_name !== 'Â∫óËàó‰∏çÊòé' && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <MapPin className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>Â†¥ÊâÄ</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <div className="flex items-center justify-between">
                              <Button
                                variant="ghost"
                                className="p-0 h-auto font-normal hover:bg-transparent hover:text-primary flex-1"
                                onClick={handleCopyStoreName}
                                title="Â∫óËàóÂêç„Çí„Ç≥„Éî„Éº"
                              >
                                <span className={cn(
                                  "whitespace-normal break-words",
                                  (post.store_name || '').length > 20 ? "text-sm" : "text-base"
                                )} style={{ color: '#73370c' }}>
                                  {post.store_name}
                                </span>
                              </Button>
                              <Button
                                variant="ghost"
                                size="sm"
                                onClick={handleCopyStoreName}
                                className="p-1 h-auto hover:bg-gray-100"
                                title="Â∫óËàóÂêç„Çí„Ç≥„Éî„Éº"
                              >
                                <Copy className="h-4 w-4 text-gray-400 hover:text-gray-600 flex-shrink-0" />
                              </Button>
                            </div>
                          </td>
                        </tr>
                      )}
                      
                      {/* 2Ë°åÁõÆ: „Ç∏„É£„É≥„É´ - „Ç∏„É£„É≥„É´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ */}
                      {post.genre && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <GenreIcon className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>„Ç∏„É£„É≥„É´</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <div className={cn(
                              "inline-flex items-center space-x-2 px-3 py-1 rounded-full text-base font-medium border",
                              genreIconAndColor.bgColor,
                              genreIconAndColor.textColor,
                              genreIconAndColor.borderColor
                            )}>
                              <GenreIcon className="h-4 w-4 flex-shrink-0" />
                              <span>{post.genre}</span>
                            </div>
                          </td>
                        </tr>
                      )}
                      
                      {/* 3Ë°åÁõÆ: „Ç´„ÉÜ„Ç¥„É™ - „Ç´„ÉÜ„Ç¥„É™„Åånull„Åæ„Åü„ÅØundefined„Åß„ÅØ„Å™„ÅÑÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ */}
                      {post.category && post.category !== '' && post.category !== null && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <Tag className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>„Ç´„ÉÜ„Ç¥„É™</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <Badge className={cn("text-base", getCategoryColor(post.category))}>
                              {post.category}
                            </Badge>
                          </td>
                        </tr>
                      )}
                      
                      {/* 4Ë°åÁõÆ: ‰æ°Ê†º - ‰æ°Ê†º„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫ */}
                      {post.price != null && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <DollarSign className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>‰æ°Ê†º</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <span className="text-base font-medium" style={{ color: '#73370c' }}>
                              {post.price.toLocaleString()}ÂÜÜ„Äú
                            </span>
                          </td>
                        </tr>
                      )}
                      
                      {/* 8Ë°åÁõÆ: „É™„É≥„ÇØ - Êó¢„Å´Êù°‰ª∂ÂàÜÂ≤êÊ∏à„Åø */}
                      {post.url && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <LinkIcon className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>„É™„É≥„ÇØ</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <a
                              href={post.url}
                              target="_blank"
                              rel="noopener noreferrer"
                              className="text-blue-600 hover:text-blue-800 underline break-all"
                              onClick={(e) => e.stopPropagation()}
                            >
                              {post.url}
                            </a>
                          </td>
                        </tr>
                      )}
                      
                      {/* 9Ë°åÁõÆ: „Éï„Ç°„Ç§„É´ - Êó¢„Å´Êù°‰ª∂ÂàÜÂ≤êÊ∏à„Åø */}
                      {fileUrls.length > 0 && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <FileIcon className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>„Éï„Ç°„Ç§„É´</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <div className="space-y-2">
                              {fileUrls.map((fileUrl, index) => {
                                const fileName = fileUrl.split('/').pop() || `„Éï„Ç°„Ç§„É´${index + 1}`;
                                return (
                                  <a
                                    key={index}
                                    href={fileUrl}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    className="flex items-center space-x-2 text-blue-600 hover:text-blue-800 underline"
                                    onClick={(e) => e.stopPropagation()}
                                  >
                                    <span className="text-lg">{getFileIcon(fileName)}</span>
                                    <span className="break-all">{fileName}</span>
                                  </a>
                                );
                              })}
                            </div>
                          </td>
                        </tr>
                      )}
                      
                      {/* üî• ÂØæË±°ËÄÖÊÉÖÂ†±„ÅÆË°®Á§∫Ôºà„Éï„Ç°„Ç§„É´„ÅÆÂæå„ÄÅË¶ñËÅ¥ÂõûÊï∞„ÅÆÂâç„Å´ËøΩÂä†Ôºâ */}
                      {post.target_audience && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <Users className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>ÂØæË±°ËÄÖ</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <Badge className="bg-blue-100 text-blue-800 border-blue-200 text-base">
                              {getTargetAudienceLabel(post.target_audience)}
                            </Badge>
                          </td>
                        </tr>
                      )}
                      
                      {/* Ë¶ñËÅ¥ÂõûÊï∞Ë°å - Â∏∏„Å´Ë°®Á§∫ */}
                      <tr className="border-b border-gray-100">
                        <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                          <div className="flex items-center space-x-2">
                            <Eye className="h-4 w-4 text-gray-500 flex-shrink-0" />
                            <span className="text-base" style={{ color: '#73370c' }}>Ë¶ñËÅ¥ÂõûÊï∞</span>
                          </div>
                        </td>
                        <td className="p-3">
                          <span className="text-base" style={{ color: '#73370c' }}>
                            {formatViewCount(post.views_count)}
                          </span>
                        </td>
                      </tr>
                      
                      {/* ÊÆã„ÇäÊôÇÈñìË°å - Â∏∏„Å´Ë°®Á§∫ */}
                      <tr className={cn(showDistance && post.distance !== undefined ? "border-b border-gray-100" : "")}>
                        <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                          <div className="flex items-center space-x-2">
                            <Clock className="h-4 w-4 text-gray-500 flex-shrink-0" />
                            <span className="text-base" style={{ color: '#73370c' }}>ÊÆã„ÇäÊôÇÈñì</span>
                          </div>
                        </td>
                        <td className="p-3">
                          <span className="text-base" style={{ color: '#73370c' }}>
                            {post.expires_at ? formatRemainingTime(new Date(post.expires_at).getTime()) : 'ÊúüÈôê„Å™„Åó'}
                          </span>
                        </td>
                      </tr>
                      
                      {/* 7Ë°åÁõÆ: Ë∑ùÈõ¢ÔºàÈñãÁô∫Áí∞Â¢É„Åß„ÅÆ„ÅøË°®Á§∫Ôºâ
                      {showDistance && post.distance !== undefined && (
                        <tr>
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <MapPin className="h-4 w-4 text-gray-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>Ë∑ùÈõ¢</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <span className="text-base font-medium text-blue-600">
                              {formatDistance(post.distance)}
                            </span>
                          </td>
                        </tr>
                      )} */}

                      {/* üî• ÂøúÊè¥Ë≥ºÂÖ•Ë°®Á§∫„ÇíË©≥Á¥∞ÊÉÖÂ†±„ÉÜ„Éº„Éñ„É´„Å´ËøΩÂä†ÔºàÊÆã„ÇäÊôÇÈñì„ÅÆÂâçÔºâ */}
                      {post.support_purchase_enabled && post.support_purchase_options && (
                        <tr className="border-b border-gray-100">
                          <td className="p-3 bg-gray-50 w-1/3 font-medium border-r border-gray-100">
                            <div className="flex items-center space-x-2">
                              <Heart className="h-4 w-4 text-pink-500 flex-shrink-0" />
                              <span className="text-base" style={{ color: '#73370c' }}>ÂøúÊè¥Ë≥ºÂÖ•</span>
                            </div>
                          </td>
                          <td className="p-3">
                            <div className="flex flex-wrap gap-2">
                              {JSON.parse(post.support_purchase_options).map((amount: number, index: number) => {
                                const loadingKey = `${post.id}-${amount}`;
                                const isLoading = supportPurchaseLoading[loadingKey];
                                
                                return (
                                  <Button
                                    key={index}
                                    variant="outline"
                                    size="sm"
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleSupportPurchase(post.id, amount);
                                    }}
                                    className={cn(
                                      "bg-gradient-to-r from-orange-50 to-red-50 text-[#73370c] border-orange-200 font-semibold transition-all duration-300 transform",
                                      "hover:from-orange-100 hover:to-red-100 hover:border-orange-300 hover:shadow-md hover:scale-105",
                                      "active:scale-95 active:shadow-sm",
                                      isLoading && "opacity-75 cursor-not-allowed",
                                      isMyPost && "opacity-50 cursor-not-allowed hover:scale-100"
                                    )}
                                    disabled={isMyPost || isLoading}
                                    title={isMyPost ? "Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Å´„ÅØÂøúÊè¥Ë≥ºÂÖ•„Åß„Åç„Åæ„Åõ„Çì" : `¬•${amount.toLocaleString()}„ÅßÂøúÊè¥„Åô„Çã`}
                                  >
                                    {isLoading ? (
                                      <>
                                        <motion.div
                                          animate={{ rotate: 360 }}
                                          transition={{ duration: 1, repeat: Infinity, ease: "linear" }}
                                          className="h-3 w-3 mr-1"
                                        >
                                          <Loader2 className="h-3 w-3 text-[#73370c]" />
                                        </motion.div>
                                        Âá¶ÁêÜ‰∏≠...
                                      </>
                                    ) : (
                                      <>
                                        <HandCoins className="h-3 w-3 mr-1" />
                                        ¬•{amount.toLocaleString()}
                                      </>
                                    )}
                                  </Button>
                                );
                              })}
                            </div>
                            {isMyPost && (
                              <p className="text-xs text-gray-500 mt-1">‚ÄªËá™ÂàÜ„ÅÆÊäïÁ®ø„Å´„ÅØÂøúÊè¥Ë≥ºÂÖ•„Åß„Åç„Åæ„Åõ„Çì</p>
                            )}
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </motion.div>
            </div>
          </div>
        </CardHeader>
        
        <CardContent className="p-3 pt-1 flex flex-col h-full">
          {/* ÊäïÁ®øÂÜÖÂÆπ„Å®„ÅÆÈñìÈöîË™øÊï¥ */}
          <div className="flex-grow overflow-hidden mb-3 mt-1">
            <p className="text-lg whitespace-pre-line" style={{ color: '#73370c' }}>
              {post.content ? (post.content.length > 240 ? post.content.substring(0, 240) + '...' : post.content) : 'ÂÜÖÂÆπ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì'}
            </p>
          </div>
          
          {/* ÁîªÂÉèË°®Á§∫„Ç®„É™„Ç¢ÔºàË§áÊï∞ÁîªÂÉèÂØæÂøúÔºâ */}
          {imageUrls.length > 0 && (
            <div className="flex justify-center w-full mb-3">
              <div className="relative rounded-md overflow-hidden">
                {imageUrls.length === 1 ? (
                  // Âçò‰∏ÄÁîªÂÉè„ÅÆÂ†¥Âêà
                  <OptimizedImage
                    src={imageUrls[0]}
                    alt="ÊäïÁ®øÁîªÂÉè"
                    className="w-full h-full"
                    onLoad={() => setImageLoaded(true)}
                  />
                ) : (
                  // Ë§áÊï∞ÁîªÂÉè„ÅÆÂ†¥ÂêàÔºà„Ç´„É´„Éº„Çª„É´Ôºâ
                  <Carousel className="w-full h-full">
                    <CarouselContent>
                      {imageUrls.map((imageUrl, index) => (
                        <CarouselItem key={index}>
                          <OptimizedImage
                            src={imageUrl}
                            alt={`ÊäïÁ®øÁîªÂÉè ${index + 1}`}
                            className="w-full h-full"
                            onLoad={() => setImageLoaded(true)}
                          />
                        </CarouselItem>
                      ))}
                    </CarouselContent>
                    
                    {/* „Ç´„É´„Éº„Çª„É´„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ */}
                    <CarouselPrevious 
                      className="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white/90 text-gray-700 border-gray-300 shadow-lg"
                      size="sm"
                    />
                    <CarouselNext 
                      className="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white/90 text-gray-700 border-gray-300 shadow-lg"
                      size="sm"
                    />
                    
                    {/* ÁîªÂÉè„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */}
                    <div className="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-1">
                      {imageUrls.map((_, index) => (
                        <div
                          key={index}
                          className="w-2 h-2 rounded-full bg-white/60 shadow-sm"
                        />
                      ))}
                    </div>
                  </Carousel>
                )}
              </div>
            </div>
          )}

          {/* Êñ∞„Åó„ÅÑÁµ±Ë®à„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥Ë°åÔºàÊ®™ÂπÖÈáçË¶ñ„ÅÆ„É¨„Ç§„Ç¢„Ç¶„ÉàÔºâ */}
          <div className="bg-gray-50 rounded-lg p-2 mt-2">
            <div className="grid grid-cols-3 gap-1 h-6">
              {/* „ÅÑ„ÅÑ„Å≠ */}
              <button
                onClick={handleLikeClick}
                className={cn(
                  "flex items-center justify-center space-x-1 h-full rounded-md transition-colors px-1 border border-gray-300",
                  isLiked && "text-red-500",
                  isMyPost && currentUserId && "opacity-50 cursor-not-allowed",
                  isLiking && "opacity-50 cursor-not-allowed"
                )}
                style={{ backgroundColor: '#fcebeb' }}
                disabled={isLiking || (isMyPost && Boolean(currentUserId))}
                title={isMyPost && currentUserId ? "Ëá™ÂàÜ„ÅÆÊäïÁ®ø„Å´„ÅØ„ÅÑ„ÅÑ„Å≠„Åß„Åç„Åæ„Åõ„Çì" : "„ÅÑ„ÅÑ„Å≠"}
              >
                <Heart className={cn(
                  "h-4 w-4 transition-all duration-200 flex-shrink-0",
                  isLiked ? "text-red-500 fill-red-500" : "text-gray-600 hover:text-red-500",
                  isLiking && "animate-pulse"
                )} />
                <span className="text-base font-medium truncate">{post.likes_count}</span>
                <span className="text-base text-gray-500 truncate">„ÅÑ„ÅÑ„Å≠</span>
              </button>

              {/* „Ç≥„É°„É≥„ÉàÊï∞ */}
              {enableComments && (
                <button
                  onClick={handleCommentClick}
                  className="flex items-center justify-center space-x-1 h-full rounded-md transition-colors text-gray-600 hover:text-blue-500 px-1 border border-gray-300"
                  style={{ backgroundColor: '#eff4ff' }}
                  title="„Ç≥„É°„É≥„Éà"
                >
                  <MessageCircle className="h-4 w-4 flex-shrink-0" />
                  <span className="text-base font-medium truncate">{formatCommentCount(post.comments_count)}</span>
                  <span className="text-base text-gray-500 truncate">„Ç≥„É°„É≥„Éà</span>
                </button>
              )}

              {/* „Ç∑„Çß„Ç¢„Éú„Çø„É≥ */}
              <button
                onClick={handleShareClick}
                className="flex items-center justify-center space-x-1 h-full rounded-md transition-colors text-gray-600 hover:text-gray-800 px-1 border border-gray-300"
                style={{ backgroundColor: '#eefdf6' }}
                title="ÂÖ±Êúâ"
              >
                <Share2 className="h-4 w-4 flex-shrink-0" />
                <span className="text-base font-medium truncate">ÂÖ±Êúâ</span>
              </button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* üî• ËøΩÂä†ÔºöÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ */}
      <CustomModal
        isOpen={showDeleteModal}
        onClose={() => setShowDeleteModal(false)}
        title="ÊäïÁ®ø„ÅÆÂâäÈô§"
        description="„Åì„ÅÆÊäïÁ®ø„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü"
      >
        <div className="space-y-4">
          <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
            <div className="flex items-center space-x-2">
              <AlertTriangle className="h-5 w-5 text-red-600" />
              <span className="text-red-800 font-medium">Ê≥®ÊÑè</span>
            </div>
            <p className="text-red-700 text-sm mt-2">
              ÂâäÈô§„Åó„ÅüÊäïÁ®ø„ÅØÂæ©ÂÖÉ„Åß„Åç„Åæ„Åõ„Çì„ÄÇÊú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü
            </p>
          </div>
          
          <div className="flex justify-end space-x-3">
            <Button
              variant="outline"
              onClick={() => setShowDeleteModal(false)}
              disabled={isDeleting}
            >
              „Ç≠„É£„É≥„Çª„É´
            </Button>
            <Button
              variant="destructive"
              onClick={handleDeletePost}
              disabled={isDeleting}
            >
              {isDeleting ? (
                <>
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  ÂâäÈô§‰∏≠...
                </>
              ) : (
                <>
                  <Trash2 className="h-4 w-4 mr-2" />
                  ÂâäÈô§„Åô„Çã
                </>
              )}
            </Button>
          </div>
        </div>
      </CustomModal>

      {/* üî• ÊîπËâØÔºöÈÄöÂ†±„É¢„Éº„ÉÄ„É´ */}
      <CustomModal
        isOpen={showReportModal}
        onClose={() => setShowReportModal(false)}
        title="ÊäïÁ®ø„ÇíÈÄöÂ†±"
        description="‰∏çÈÅ©Âàá„Å™ÊäïÁ®ø„ÇíÂ†±Âëä„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
        className="sm:max-w-md"
      >
        <div className="space-y-4">
          <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
            <div className="flex items-center space-x-2">
              <AlertTriangle className="h-4 w-4 text-amber-600" />
              <span className="text-amber-800 font-medium text-sm">ÈÄöÂ†±„Å´„Å§„ÅÑ„Å¶</span>
            </div>
            <p className="text-amber-700 text-xs mt-1">
              ÈÄöÂ†±„ÅÑ„Åü„Å†„ÅÑ„ÅüÂÜÖÂÆπ„ÅØÈÅãÂñ∂„ÉÅ„Éº„É†„ÅÆ„É°„Éº„É´„Å´ÈÄÅ‰ø°„Åï„Çå„ÄÅÈÅ©Âàá„Å´ÂØæÂøú„ÅÑ„Åü„Åó„Åæ„Åô„ÄÇ
            </p>
          </div>

          <div>
            <label className="block text-sm font-medium mb-2 text-gray-700">ÈÄöÂ†±ÁêÜÁî± <span className="text-red-500">*</span></label>
            <select
              value={reportReason}
              onChange={(e) => setReportReason(e.target.value)}
              className="w-full p-3 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900"
            >
              <option value="">ÁêÜÁî±„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
              <option value="spam">„Çπ„Éë„É†„ÉªÈÅéÂ∫¶„Å™ÂÆ£‰ºù</option>
              <option value="inappropriate">‰∏çÈÅ©Âàá„Å™ÂÜÖÂÆπ„ÉªÁîªÂÉè</option>
              <option value="harassment">Â´å„Åå„Çâ„Åõ„ÉªË™πË¨ó‰∏≠ÂÇ∑</option>
              <option value="fake">ËôöÂÅΩ„ÉªË™§Ëß£„ÇíÊãõ„ÅèÊÉÖÂ†±</option>
              <option value="violence">Êö¥ÂäõÁöÑ„Å™ÂÜÖÂÆπ</option>
              <option value="adult">„Ç¢„ÉÄ„É´„Éà„ÉªÊÄßÁöÑ„Å™ÂÜÖÂÆπ</option>
              <option value="copyright">Ëëó‰ΩúÊ®©‰æµÂÆ≥</option>
              <option value="privacy">ÂÄã‰∫∫ÊÉÖÂ†±„ÅÆÊºèÊ¥©</option>
              <option value="illegal">ÈÅïÊ≥ïË°åÁÇ∫„ÉªÂç±Èô∫Ë°åÁÇ∫</option>
              <option value="other">„Åù„ÅÆ‰ªñ</option>
            </select>
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-2 text-gray-700">Ë©≥Á¥∞ÊÉÖÂ†±Ôºà‰ªªÊÑèÔºâ</label>
            <textarea
              value={reportDetails}
              onChange={(e) => setReportDetails(e.target.value)}
              placeholder="ÂÖ∑‰ΩìÁöÑ„Å™ÂïèÈ°åÁÇπ„ÇÑË©≥Á¥∞„Åå„ÅÇ„Çå„Å∞Ë®òËºâ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà500ÊñáÂ≠ó‰ª•ÂÜÖÔºâ"
              className="w-full p-3 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white text-gray-900 placeholder-gray-500 resize-none"
              rows={6}
              maxLength={500}
              style={{ fontSize: '16px' }}
            />
            <div className="text-xs text-gray-500 mt-1">
              {reportDetails.length}/500ÊñáÂ≠ó
            </div>
          </div>
          <div className="flex justify-end space-x-3">
            <Button
              variant="outline"
              onClick={() => {
                setShowReportModal(false);
                setReportReason('');
                setReportDetails('');
              }}
              disabled={isReporting}
            >
              „Ç≠„É£„É≥„Çª„É´
            </Button>
            <Button
              onClick={handleReportPost}
              disabled={isReporting || !reportReason.trim()}
              className="bg-red-600 hover:bg-red-700"
            >
              {isReporting ? (
                <>
                  <Loader2 className="h-4 w-4 animate-spin mr-2" />
                  ÈÄÅ‰ø°‰∏≠...
                </>
              ) : (
                <>
                  <Flag className="h-4 w-4 mr-2" />
                  ÈÄöÂ†±„Åô„Çã
                </>
              )}
            </Button>
          </div>
        </div>
      </CustomModal>

      {/* üî• Êõ¥Êñ∞ÔºöÂÖ±Êúâ„É¢„Éº„ÉÄ„É´ÔºàÈÄöÂ†±Ê©üËÉΩËøΩÂä†Ôºâ */}
      <CustomModal
        isOpen={showShareDialog}
        onClose={() => setShowShareDialog(false)}
        title="ÊäïÁ®ø„ÇíÂÖ±Êúâ"
        description="„Åì„ÅÆ„ÅäÂæóÊÉÖÂ†±„ÇíÂèãÈÅî„Å´Áü•„Çâ„Åõ„Çà„ÅÜÔºÅ"
      >
        <div className="space-y-3">
          <Button
            variant="outline"
            className="w-full justify-start text-left py-3 h-auto text-base"
            onClick={() => {
                copyToClipboard(`${window.location.origin}/post/${post.id}`, "„É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ");
            }}
          >
            <LinkIcon className="mr-2.5 h-5 w-5" />
            „É™„É≥„ÇØ„Çí„Ç≥„Éî„Éº
          </Button>
          <Button
            className="w-full justify-start text-left py-3 h-auto text-base bg-[#1DA1F2] hover:bg-[#1a91da] text-white"
            onClick={() => {
                window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(`${post.store_name}„ÅÆ${post.category}„Åå„ÅäÂæóÔºÅ ${post.content}`)}&url=${encodeURIComponent(`${window.location.origin}/post/${post.id}`)}`, '_blank');
                setShowShareDialog(false);
            }}
          >
            <svg className="mr-2.5 h-5 w-5 fill-current" viewBox="0 0 24 24" aria-hidden="true"><g><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></g></svg>
            X (Twitter) „ÅßÂÖ±Êúâ
          </Button>
          <Button
            variant="outline"
            className="w-full justify-start text-left py-3 h-auto text-base bg-[#E1306C] hover:bg-[#c92a5f] text-white"
            onClick={handleInstagramShare}
          >
            <Instagram className="mr-2.5 h-5 w-5" />
            Instagram„ÅßÂÖ±Êúâ
          </Button>
          {navigator.share && typeof navigator.share === 'function' && (
            <Button
              variant="outline"
              className="w-full justify-start text-left py-3 h-auto text-base"
              onClick={handleNativeShare}
            >
              <ExternalLink className="mr-2.5 h-5 w-5" />
              „Åù„ÅÆ‰ªñ„ÅÆ„Ç¢„Éó„É™„ÅßÂÖ±Êúâ
            </Button>
          )}
          
          {/* üî• ËøΩÂä†ÔºöÈÄöÂ†±„Éú„Çø„É≥ */}
          {!isMyPost && (
            <>
              <hr className="my-2" />
              <Button
                variant="outline"
                className="w-full justify-start text-left py-3 h-auto text-base text-red-600 hover:bg-red-50 hover:text-red-700"
                onClick={() => {
                  setShowShareDialog(false);
                  setShowReportModal(true);
                }}
              >
                <Flag className="mr-2.5 h-5 w-5" />
                „Åì„ÅÆÊäïÁ®ø„ÇíÈÄöÂ†±
              </Button>
            </>
          )}
        </div>
        <div className="mt-6 flex justify-end">
            <Button variant="ghost" onClick={() => setShowShareDialog(false)} className="text-base px-5 py-2.5 h-auto">Èñâ„Åò„Çã</Button>
        </div>
      </CustomModal>
    </>
  );
});

PostCard.displayName = 'PostCard';